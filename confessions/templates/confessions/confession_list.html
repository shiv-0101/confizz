{% extends 'confessions/base.html' %}

{% block title %}Home - AI Confizz{% endblock %}

{% block content %}
<!-- Left Sidebar -->
<aside class="reddit-sidebar">
    <h3><span class="material-icons" style="vertical-align: middle; margin-right: 0.5rem; font-size: 1.3rem;">menu</span> Navigation</h3>
    <ul class="reddit-sidebar-nav">
        <li><a href="{% url 'confessions:confession_list' %}" class="active"><span class="material-icons">home</span> Home</a></li>
        {% if user.is_authenticated %}
            <li><a href="{% url 'confessions:user_dashboard' %}"><span class="material-icons">dashboard</span> Dashboard</a></li>
            <li><a href="{% url 'confessions:logout' %}"><span class="material-icons">exit_to_app</span> Logout</a></li>
        {% else %}
            <li><a href="{% url 'confessions:login' %}"><span class="material-icons">login</span> Login</a></li>
            <li><a href="{% url 'confessions:signup' %}"><span class="material-icons">person_add</span> Sign Up</a></li>
        {% endif %}
        <li><a href="{% url 'community-list' %}"><span class="material-icons">collections</span> Communities</a></li>
    </ul>
</aside>

<!-- Main Feed -->
<main class="reddit-feed">
    <!-- Confession Creation Form -->
    <div class="reddit-form-card">
        <h3><span class="material-icons" style="vertical-align: middle; margin-right: 0.5rem;">edit</span> Share Your Confession</h3>
        <form method="post" action="{% url 'confessions:add_anonymous_confession' %}">
            {% csrf_token %}
            <div class="reddit-form-group">
                <textarea id="anonymous_content" name="content" rows="3" placeholder="What's on your mind? Share anonymously..." required></textarea>
            </div>
            <button type="submit" class="reddit-btn">
                <span class="material-icons" style="vertical-align: middle; margin-right: 0.5rem;">send</span>
                Post Anonymously
            </button>
        </form>
    </div>

    <!-- Confessions Feed -->
    {% if confessions %}
        {% for confession in confessions %}
        <article class="reddit-post" data-confession-id="{{ confession.pk }}">
            <div class="reddit-post-container">
                <!-- Vote Section -->
                <div class="reddit-post-votes">
                    <button class="upvote-btn" title="Upvote">
                        <span class="material-icons">arrow_upward</span>
                    </button>
                    <span class="reddit-vote-count upvote-count">{{ confession.upvotes }}</span>
                    <button title="Downvote">
                        <span class="material-icons" style="font-size: 1.2rem;">arrow_downward</span>
                    </button>
                </div>

                <!-- Post Content -->
                <div class="reddit-post-content">
                    <div class="reddit-post-header">
                        {% if confession.author %}
                            <span class="reddit-post-author">u/{{ confession.author.username }}</span>
                        {% else %}
                            <span class="reddit-post-author">u/Anonymous</span>
                        {% endif %}
                        <span class="reddit-post-meta">{{ confession.created_at|timesince }} ago</span>
                        {% if confession.community %}
                            <span class="reddit-post-meta" style="margin-left: auto;">
                                <span class="material-icons" style="font-size: 0.9rem; vertical-align: middle;">public</span>
                                <a href="{% url 'confessions:community_detail' slug=confession.community.slug %}" style="color: var(--primary-color); text-decoration: none;">
                                    {{ confession.community.name }}
                                </a>
                            </span>
                        {% endif %}
                    </div>

                    <p class="reddit-post-text">{{ confession.content }}</p>

                    <!-- Post Actions -->
                    <div class="reddit-post-actions">
                        <button class="reddit-post-action comment-toggle-btn" onclick="toggleComments(this, '{{ confession.pk }}')">
                            <span class="material-icons">chat_bubble_outline</span>
                            <span>{{ confession.comments.count }} Comments</span>
                        </button>
                        <button class="reddit-post-action summarise-btn" title="AI Summarise">
                            <span class="material-icons">auto_awesome</span>
                            <span>AI Summarise</span>
                        </button>
                        <button class="reddit-post-action" title="Share">
                            <span class="material-icons">share</span>
                            <span>Share</span>
                        </button>
                    </div>

                    <!-- Comments Section -->
                    <div class="reddit-comments" id="comments-section-{{ confession.pk }}" style="display: none;">
                        <div style="max-height: 400px; overflow-y: auto;">
                            {% for comment in confession.comments.all %}
                                <div class="reddit-comment">
                                    <div class="reddit-comment-header">
                                        {% if comment.author %}
                                            <span class="reddit-comment-author">u/{{ comment.author.username }}</span>
                                        {% else %}
                                            <span class="reddit-comment-author">u/Anonymous</span>
                                        {% endif %}
                                        <span class="reddit-comment-time">{{ comment.created_at|timesince }} ago</span>
                                    </div>
                                    <div class="reddit-comment-text">{{ comment.content }}</div>
                                </div>
                            {% empty %}
                                <div class="reddit-comment reddit-text-center reddit-text-muted">
                                    No comments yet. Be the first to comment!
                                </div>
                            {% endfor %}
                        </div>

                        <!-- Add Comment Form -->
                        <form action="{% url 'confessions:add_comment' confession.pk %}" method="post" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                            {% csrf_token %}
                            <div class="reddit-form-group" style="margin-bottom: 0;">
                                {{ comment_form }}
                                <button type="submit" class="reddit-btn" style="margin-top: 0.5rem; padding: 0.5rem 1rem; font-size: 0.85rem;">
                                    <span class="material-icons" style="font-size: 0.85rem; vertical-align: middle; margin-right: 0.25rem;">send</span>
                                    Post
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- AI Summary Section -->
                    <div id="summary-{{ confession.pk }}" style="display: none; margin-top: 1rem; padding: 1rem; background-color: var(--background-color); border-left: 3px solid var(--primary-color); border-radius: 4px;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; color: var(--primary-color); font-weight: 600;">
                            <span class="material-icons">auto_awesome</span>
                            AI Summary
                        </div>
                        <p class="reddit-text-secondary" id="summary-content-{{ confession.pk }}">Summary will appear here...</p>
                    </div>
                </div>
            </div>
        </article>
        {% endfor %}
    {% else %}
        <article class="reddit-post">
            <div class="reddit-post-container">
                <div class="reddit-post-votes">
                    <button class="upvote-btn" disabled>
                        <span class="material-icons">arrow_upward</span>
                    </button>
                    <span class="reddit-vote-count">42</span>
                    <button disabled>
                        <span class="material-icons">arrow_downward</span>
                    </button>
                </div>

                <div class="reddit-post-content">
                    <div class="reddit-post-header">
                        <span class="reddit-post-author">u/Example</span>
                        <span class="reddit-post-meta">2 hours ago</span>
                    </div>
                    <p class="reddit-post-text">ðŸ‘‹ Welcome to Confizz! This is a sample confession to show you how the platform works. Share your secrets, thoughts, and confessions anonymously. Get AI-powered summaries of discussions. Upvote and comment on confessions you relate to. No judgment, just community!</p>
                    <div class="reddit-post-actions">
                        <button class="reddit-post-action" disabled>
                            <span class="material-icons">chat_bubble_outline</span>
                            <span>5 Comments</span>
                        </button>
                        <button class="reddit-post-action" disabled>
                            <span class="material-icons">auto_awesome</span>
                            <span>AI Summarise</span>
                        </button>
                        <button class="reddit-post-action" disabled>
                            <span class="material-icons">share</span>
                            <span>Share</span>
                        </button>
                    </div>
                </div>
            </div>
        </article>
    {% endif %}
</main>

<!-- Right Sidebar -->
<aside class="reddit-right-sidebar">
    <h3><span class="material-icons" style="vertical-align: middle; margin-right: 0.5rem;">info</span> About</h3>
    <div class="reddit-info-box">
        <strong>ðŸ“¢ r/Confizz</strong><br>
        A safe space to share your confessions and secrets anonymously.
    </div>
    <div class="reddit-info-box">
        <strong>âœ¨ Features</strong><br>
        â€¢ Anonymous posting<br>
        â€¢ AI-powered summaries<br>
        â€¢ Community voting<br>
        â€¢ Real discussions
    </div>
    <div class="reddit-info-box">
        <strong>ðŸ“Š Stats</strong><br>
        Total Confessions: {{ total_confessions|default:"Loading..." }}<br>
        Total Comments: {{ total_comments|default:"Loading..." }}
    </div>
</aside>
{% endblock %}

{% block scripts %}
<script>
    function toggleComments(button, confessionId) {
        const commentsSection = document.getElementById(`comments-section-${confessionId}`);
        if (commentsSection.style.display === 'none') {
            commentsSection.style.display = 'block';
            button.style.color = 'var(--primary-color)';
        } else {
            commentsSection.style.display = 'none';
            button.style.color = 'var(--text-secondary)';
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        document.body.addEventListener('click', function(event) {
            const upvoteButton = event.target.closest('.upvote-btn');
            const summariseButton = event.target.closest('.summarise-btn');

            // Handle Upvote Clicks
            if (upvoteButton) {
                const voteCount = upvoteButton.nextElementSibling;
                let currentCount = parseInt(voteCount.textContent, 10);
                voteCount.textContent = currentCount + 1;
                upvoteButton.style.color = 'var(--upvote-color)';
            }

            // Handle AI Summarise
            if (summariseButton) {
                event.preventDefault();

                const post = summariseButton.closest('.reddit-post');
                const confessionId = post.dataset.confessionId;
                
                if (confessionId === 'dummy') {
                    alert("This is a demo post. Sign in and post a real confession to use AI features!");
                    return;
                }

                const summaryContainer = post.querySelector(`#summary-${confessionId}`);
                const summaryContent = post.querySelector(`#summary-content-${confessionId}`);
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

                summaryContent.innerHTML = '<span class="material-icons" style="vertical-align: middle; animation: spin 1s linear infinite;">refresh</span> Analyzing...';
                summaryContainer.style.display = 'block';

                const commentsSection = post.querySelector(`#comments-section-${confessionId}`);
                const commentElements = commentsSection?.querySelectorAll('.reddit-comment-text') || [];
                const commentsText = Array.from(commentElements).map(el => el.textContent.trim()).join('\n');

                fetch(`/confessions/confession/${confessionId}/summarize/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body: JSON.stringify({ comments_text: commentsText })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.summary) {
                        summaryContent.textContent = data.summary;
                    } else {
                        summaryContent.textContent = `Error: ${data.error || 'An unknown error occurred.'}`;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    summaryContent.textContent = 'Failed to fetch summary. Check console for details.';
                });
            }
        });
    });

    // Spin animation for loading
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}